@using EShop.Core.ExtensionMethods
@using EShop.Core.ViewModels
@using EShop.DataLayer.Enum
@model EShop.Core.ViewModels.Cart.ShippingPageViewModel
@{
    ViewData["Title"] = "سبد خرید";
    Layout = "~/Views/Shared/_Layout.cshtml";
    int specialprice = 0;
    int mainprice = 0;
    bool isColleague = ViewBag.IsColleague;
    int isColleagueVal = isColleague ? 1 : 0;
}
@section Meta
    {
    @await Html.PartialAsync("_noIndex")

}

@section Style{
      <link rel="stylesheet" href="/css/vendor/bootstrap.min.css">


}
<div class="container">
    <input type="hidden" value="@isColleagueVal" id="isColleague" />
    <div class="d-block">
        <section class="blog-checkout d-block order-1">
            <div class="col-lg row m-0  pb-5 pt-4 ">
                <div class="checkout woocommerce-checkout col-md-8 p-2">
                    <div class="content-checkout container p-0">
                        @if (TempData["OrderLimit"] != null)
                    {
                        <div class="alert alert-danger clear d-flex justify-content-between">
                            محدودیت در خرید.
                            <a class="btn btn-dark btn-sm" asp-action="Page" asp-controller="Home" asp-route-id="6">مشاهدهٔ محدودیت</a>
                        </div>
                    }  @if (TempData["CompleteProfile"] != null)
                    {
                        <div class="alert alert-warning clear d-flex justify-content-between">
                            لطفا اطلاعات پروفایل خود را تکمیل کنید
                            <a class="btn btn-dark btn-sm" asp-area="User" asp-controller="Profile" asp-action="EditProfile">تکمیل پروفایل</a>
                        </div>
                    }
                    <div class="middle-container">


                        <div class="checkout-review-order">

                            <div class="c-shippingtype_form bg-white radius-15 mb-2 shadow-custom" id="mainform">
                                <h3 class="order-review-heading">آدرس تحویل گیرنده</h3>
                                @if (TempData["AddAddress"] != null)
                                {
                                    <div class="alert alert-danger clear">
                                        لطفا یک آدرس انتخاب کنید
                                    </div>
                                }
                                <ul class="checkout-payment-methods">
                                </ul>
                            </div>



                            <div class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">

                                        <form style="padding: 60px;" class="form-checkout" id="addaddressform">
                                            <div class="form-checkout-row">
                                                <div class="d-flex">
                                                    <div class="col-md-6 col-sm-12 col-lg-6">

                                                        <label for="FullName">نام و نام خانوادگی  <abbr class="required" title="ضروری" style="color: red;">*</abbr></label>
                                                        <input name="fullName" type="text" class="input-name-checkout form-control" />
                                                        <span class="text-danger field-validation-error-text"></span>
                                                    </div>
                                                    <div class="col-md-6 col-sm-12 col-lg-6">

                                                        <label for="Phone">شماره موبایل <abbr class="required" title="ضروری" style="color: red;">*</abbr></label>
                                                        <input name="phone" type="text" class="input-name-checkout form-control text-left">
                                                        <span class="text-danger"></span>

                                                    </div>
                                                </div>
                                                <div class="d-flex">
                                                    <div class="col-md-6 col-sm-12 col-lg-6">
                                                        <label for="province">
                                                            استان
                                                            <abbr class="required" title="ضروری" style="color: red;">*</abbr>
                                                        </label>
                                                        <select name="provinceId" class="province" class="form-control">
                                                            <option value="" selected="selected">استان مورد نظر خود را انتخاب کنید </option>
                                                            @foreach (var item in ViewBag.provincelist)
                                                            {
                                                                <option value=@item.ProvinceId selected="selected">@item.ProvinceName</option>
                                                            }
                                                        </select>
                                                        <span class="text-danger"></span>

                                                    </div>
                                                    <div class="col-md-6 col-sm-12 col-lg-6">
                                                        <label for="city">
                                                            شهر
                                                            <abbr class="required" title="ضروری" style="color: red;">*</abbr>
                                                        </label>
                                                        <select name="cityId" id="cityid" class="form-control">
                                                            <option value="" selected="selected">شهر مورد نظر خود را انتخاب کنید</option>

                                                        </select>
                                                        <span class="text-danger"></span>
                                                    </div>
                                                </div>

                                                <label for="post-code">کد پستی<abbr class="required" title="ضروری" style="color: red;">*</abbr></label>
                                                <input name="postalCode" type="text" class="input-name-checkout form-control" placeholder="کد پستی را بدون خط تیره بنویسید">
                                                <span class="text-danger"></span>

                                                <label for="address">
                                                    آدرس
                                                    <abbr class="required" title="ضروری" style="color: red;">*</abbr>
                                                </label>
                                                <textarea name="postalAddress" rows="5" cols="30" class="textarea-name-checkout form-control" placeholder="آدرس را وارد نمایید"></textarea>
                                                <span class="text-danger"></span>

                                                <div class="form-auth-row p-4">
                                                    <div class="g-recaptcha d-flex justify-content-center" data-sitekey="6LcjEtAeAAAAALXzQnvI6iRs3JhVGBgtyN0mOsgp"></div>
                                                    <span id="recaptchaerror" class="text-danger"></span>
                                                </div>
                                                <div class="AR-CR">
                                                    <button class="btn-registrar"> ثبت آدرس</button>
                                                    <a class="cancel-edit-address" data-dismiss="modal" aria-label="Close">بستن</a>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="post-item-cart d-block order-2 bg-white radius-15 mb-2 shadow-custom">
                                <div class="content-page p-0">
                                    @foreach (var item in Model.Products)
                                    {
                                        specialprice += item.SpecialPrice * item.CartCount;
                                        mainprice += item.MainPrice * item.CartCount;
                                    }

                                    <div class="cart-collaterals mt-3 border-0 shadow-none">
                                        <div class="totals d-block">
                                            <div class="checkout-summary">
                                                <ul class="checkout-summary-summary">


                                                    <li class="shipping-totals d-block m-0 p-0">
                                                        <h3 class="order-review-heading">روش ارسال</h3>
                                                        @if (TempData["SelectShipment"] != null)
                                                        {
                                                            <div class="alert alert-danger clear">
                                                                لطفا روش ارسال را انتخاب کنید
                                                            </div>
                                                        }
                                                        @if (TempData["ShipmentAlert"] != null)
                                                        {
                                                            <div class="alert alert-warning clear">
                                                                @Html.Raw(TempData["ShipmentAlert"])
                                                            </div>
                                                        }
                                                        <div class="c-shippingtype_form" id="mainform-shipment">

                                                            <div class="shipping-totals-item     w-100   ">
                                                                @if (ViewBag.Shipmets != null && ((List<ShipmentForSubmitOrder>)ViewBag.Shipmets).Any())
                                                                {
                                                                    bool firstIsSelected = false;

                                                                    foreach (var shipment in (List<ShipmentForSubmitOrder>)ViewBag.Shipmets)
                                                                    {
                                                                        var shipmentId = "shipmentId_" + shipment.ShipmentId;

                                                                        <div class="shipping-totals-outline  d-flex align-items-center text-right">
                                                                            <label for="@shipmentId" class="outline-radio">
                                                                                <input type="radio" name="shippingId" class="cart-shipment" value="@shipment.ShipmentId" id="@shipmentId"
                                                                               oninput="setCustomValidity('')" oninvalid="this.setCustomValidity('لطفا روش حمل و نقل را انتخاب کنید')" required="required">
                                                                                <span class="outline-radio-check"></span>
                                                                            </label>
                                                                            <label for="@shipmentId" class="shipping-totals-title-row">
                                                                                <div class="shipping-totals-title">@shipment.Title @(shipment.Price > 0 ? ":" + shipment.Price.ToString("N0") + "تومان" : "") @(shipment.PricePerAddProduct > 0 ? "(هزینه برای هر کالای اضافه :" + shipment.PricePerAddProduct.ToString("N0") + "تومان)" : "")</div>
                                                                            </label>

                                                                        </div>
                                                                        firstIsSelected = true;
                                                                    }

                                                                }
                                                                else
                                                                {
                                                                    <span class="shipping-destination text-danger">متاسفانه سرویس حمل و نقل برای آدرس شما در نظر گرفته نشده است! لطفا آدرس جدید انتخاب کنید</span>

                                                                }

                                                            </div>
                                                        </div>
                                                    </li>

                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>


                        </div>

                    </div>
                </div>
            </div>
            <div class="cart-collaterals col-md-4 p-2 ">
                <div class=" bg-white radius-15 position-relative shadow-custom py-5">
                    <div class="post-item-cart d-flex flex-column order-2">
                        <div class="content-page p-0">

                            <div class="cart-collaterals mt-3 border-0 shadow-none">
                                <div class="totals d-block">

                                    <div class="checkout-summary">
                                        <ul class="checkout-summary-summary">
                                            <li class="cart-subtotal">

                                                <span class="amount">قیمت کالا ها </span>
                                                <span>@mainprice.ToString("N0") تومان</span>

                                            </li>
                                            @if (mainprice > specialprice)
                                            {
                                                <li class="cart-subtotal">
                                                    <span class="amount">تخفیف ها</span>
                                                    <span>
                                                        @{
                                                            var tempsumprice = mainprice - specialprice;
                                                        }
                                                        <span class="text-danger m-0">  @tempsumprice.ToString("N0") تومان</span>
                                                    </span>
                                                </li>
                                            }
                                            <li class="cart-subtotal">
                                                <span class="amount">هزینه ارسال </span>
                                                <span id="shipping-amount"> -- </span>

                                            </li>



                                            <li class="order-total">
                                                <span class="amount"> جمع کل</span>
                                                @{
                                                    int price = 0;
                                                }
                                                <span id="total-amount"> @price.ToString("N0") تومان</span>
                                                <span class="d-none" id="main-total-amount">@specialprice</span>
                                            </li>
                                        @*    <li class=" bg-danger ">
                                                <span class="amount  text-white"> مبلغ پرداختی اعتباری </span>

                                                <span id="total-amount-credit" class="text-white"> 0</span>
                                            </li>*@
                                            <li class="order-total">
                                                <span class="amount"> مبلغ قابل پرداخت </span>

                                                <span id="total-amount-final"> @price.ToString("N0") تومان</span>
                                            </li>

                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row m-0 p-3">
                            <form asp-action="SubmitOrder" method="post">
                                @if (isColleague)
                                {
                                    <hr class="mt-4 mb-4">
                                    @if (TempData["ColleagueInsuranceAlert"] != null)
                                    {
                                        <div class="alert alert-warning clear">
                                            @Html.Raw(TempData["ColleagueInsuranceAlert"])
                                        </div>
                                    }
                                    <div class="row p-3 bg-dark text-white radius-15 ">
                                        <h3 class="order-review-heading mr-0">در صد بیمه پرداخت</h3>
                                        <p>لطفا درصدی که میخواهید مشمول بیمه شود را انتخاب کنید</p>
                                        <select class="form-control" name="insurance">
                                            <option> -- انتخاب کنید -- </option>
                                            <option value="0"> -- بدون بیمه -- </option>
                                            <option value="10">10 درصد</option>
                                            <option value="20">20 درصد</option>
                                            <option value="30">30 درصد</option>
                                            <option value="40">40 درصد</option>
                                            <option value="50">50 درصد</option>
                                            <option value="60">60 درصد</option>
                                            <option value="70">70 درصد</option>
                                            <option value="80">80 درصد</option>
                                            <option value="90">90 درصد</option>
                                            <option value="100">100 درصد</option>
                                        </select>
                                    </div>
                                }


                                <div class="form-auth-row">
                                    @* <label for="#" class="ui-checkbox mt-1">
                                    <input type="checkbox" value="1" id="chkRules" oninput="setCustomValidity('')" oninvalid="this.setCustomValidity('لطفا قوانین را مطالعه و تایید نمایید')" required="required">
                                    <span class="ui-checkbox-check"></span>
                                    </label>*@
                                    @*<label for="chkRules" class="remember-me mr-0"><a href="@Url.Action("Page","Home",new{area = "",id=4})">شرایط قوانین </a>استفاده از سرویس های سایت فرنا را مطالعه نموده و با کلیه موارد آن موافقم <abbr class="required" title="ضروری" style="color: red;">*</abbr></label>*@
                                    <label for="chkRules" class="remember-me mr-0">زدن دکمهٔ ثبت نهایی به معنای پذیرش <a href="@Url.Action("Page", "Home", new { area = "", id = 4 })">شرایط قوانین </a> فروشگاه فرنا می‌باشد </label>
                                </div>
                                <hr class="mt-4 mb-4">
                                <div class="row">
                                    <h3 class="order-review-heading">روش پرداخت</h3>
                                    @if (isColleague)
                                    {
                                        <div class="alert alert-warning clear">
                                            <strong> توجه ! </strong>
                                            <br />
                                            همکار گرامی, لطفا توجه کنید شماره حساب پرداخت کننده یا صاحب پروفایل باید یکسان باشد
                                        </div>
                                    }
                                   @* @if (isColleague)
                                    {
                                        <hr class="mt-4 mb-4">
                                        @if (TempData["ColleagueCreditPriceAlert"] != null)
                                        {
                                            <div class="alert alert-danger clear">
                                                @Html.Raw(TempData["ColleagueCreditPriceAlert"])
                                            </div>
                                        }
                                        <div class="row p-3 bg-dark text-white radius-15 m-0 ">
                                            <h3 class="order-review-heading mr-0">مبلغ استفاده از اعتبار</h3>
                                            <p>لطفا مبلغی را که میخواهید به صورت اعتباری خرید کنید را انتخاب کنید</p>
                                            @{
                                                var maxPrice = specialprice > Model.UserCreditPrice ? Model.UserCreditPrice : specialprice;
                                            }
                                            <select class="form-control" name="credit" id="CreditPrice">
                                                <option value="0"> -- نقدی -- </option>
                                                @for (int i = 10000000; i < maxPrice; i += 10000000)
                                                {
                                                    <option value="@i"> @i.ToString("N0") تومان</option>

                                                }
                                                <option value="@maxPrice"> @maxPrice.ToString("N0") تومان</option>

                                            </select>
                                        </div>
                                    }*@
                                    @{
                                        if (TempData["PaymentSetting"] != null)
                                        {
                                            var paymentSetting = (SitePaymentSettingViewModel)TempData["PaymentSetting"];
                                            if (paymentSetting.ShowMelatIpg)
                                            {
                                                if (paymentSetting.DefaultIpg == EnumDefaultIpg.Melat)
                                                {
                                                    <div class="col-md-6 col-12 mt-3 text-center  pay-type">
                                                        <label for="typePay1" class="outline-radio">
                                                            <input type="radio" name="typePay" value="1" id="typePay1" checked="checked"
                                                       oninput="setCustomValidity('')" oninvalid="this.setCustomValidity('لطفا روش پرداخت را انتخاب کنید')" required="required">
                                                            <span class="outline-radio-check"></span>
                                                        </label>
                                                        <label for="typePay1" class="shipping-totals-title-row">
                                                            <div class="shipping-totals-title">
                                                                <img src="/images/mellatLogo.png" />

                                                            </div>
                                                        </label>

                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="col-md-6 col-12 mt-3 text-center  pay-type">
                                                        <label for="typePay1" class="outline-radio">
                                                            <input type="radio" name="typePay" value="1" id="typePay1"
                                                       oninput="setCustomValidity('')" oninvalid="this.setCustomValidity('لطفا روش پرداخت را انتخاب کنید')" required="required">
                                                            <span class="outline-radio-check"></span>
                                                        </label>
                                                        <label for="typePay1" class="shipping-totals-title-row">
                                                            <div class="shipping-totals-title">
                                                                <img src="/images/mellatLogo.png" />

                                                            </div>
                                                        </label>

                                                    </div>
                                                }
                                            }
                                            if (paymentSetting.ShowApIpg)
                                            {
                                                if (paymentSetting.DefaultIpg == EnumDefaultIpg.Ap)
                                                {
                                                    <div class="col-md-6 col-12 mt-3 text-center pay-type">
                                                        <label for="typePay2" class="outline-radio">
                                                            <input type="radio" name="typePay" value="2" id="typePay2" checked="checked"
                                                       oninput="setCustomValidity('')" oninvalid="this.setCustomValidity('لطفا روش پرداخت را انتخاب کنید')" required="required">
                                                            <span class="outline-radio-check"></span>
                                                        </label>
                                                        <label for="typePay2" class="shipping-totals-title-row">
                                                            <div class="shipping-totals-title">
                                                                <img src="/images/aplogo.png" />

                                                            </div>
                                                        </label>

                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="col-md-6 col-12 mt-3 text-center pay-type">
                                                        <label for="typePay2" class="outline-radio">
                                                            <input type="radio" name="typePay" value="2" id="typePay2"
                                                       oninput="setCustomValidity('')" oninvalid="this.setCustomValidity('لطفا روش پرداخت را انتخاب کنید')" required="required">
                                                            <span class="outline-radio-check"></span>
                                                        </label>
                                                        <label for="typePay2" class="shipping-totals-title-row">
                                                            <div class="shipping-totals-title">
                                                                <img src="/images/aplogo.png" />

                                                            </div>
                                                        </label>

                                                    </div>
                                                }
                                            }
                                            if (paymentSetting.ShowZarinPalIpg)
                                            {
                                                if (paymentSetting.DefaultIpg == EnumDefaultIpg.ZarinPal)
                                                {
                                                    <div class="col-md-6 col-12 mt-3 text-center  pay-type">
                                                        <label for="typePay3" class="outline-radio">
                                                            <input type="radio" name="typePay" value="3" id="typePay3" checked="checked"
                                                       oninput="setCustomValidity('')" oninvalid="this.setCustomValidity('لطفا روش پرداخت را انتخاب کنید')" required="required">
                                                            <span class="outline-radio-check"></span>
                                                        </label>
                                                        <label for="typePay3" class="shipping-totals-title-row">
                                                            <div class="shipping-totals-title">
                                                                <img src="/images/zplogo.png" width="100" />

                                                            </div>
                                                        </label>

                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="col-md-6 col-12 mt-3 text-center  pay-type">
                                                        <label for="typePay3" class="outline-radio">
                                                            <input type="radio" name="typePay" value="3" id="typePay3"
                                                       oninput="setCustomValidity('')" oninvalid="this.setCustomValidity('لطفا روش پرداخت را انتخاب کنید')" required="required">
                                                            <span class="outline-radio-check"></span>
                                                        </label>
                                                        <label for="typePay3" class="shipping-totals-title-row">
                                                            <div class="shipping-totals-title">
                                                                <img src="/images/zplogo.png" width="100" />

                                                            </div>
                                                        </label>

                                                    </div>
                                                }
                                            }
                                            if (paymentSetting.ShowKishIpg)
                                            {
                                                if (paymentSetting.DefaultIpg == EnumDefaultIpg.Kish)
                                                {
                                                    <div class="col-md-6 col-12 mt-3 text-center  pay-type">
                                                        <label for="typePay4" class="outline-radio">
                                                            <input type="radio" name="typePay" value="4" id="typePay4" checked="checked"
                                                       oninput="setCustomValidity('')" oninvalid="this.setCustomValidity('لطفا روش پرداخت را انتخاب کنید')" required="required">
                                                            <span class="outline-radio-check"></span>
                                                        </label>
                                                        <label for="typePay4" class="shipping-totals-title-row">
                                                            <div class="shipping-totals-title">
                                                                <img src="/images/Irankish-logo.png"  width="100" />

                                                            </div>
                                                        </label>

                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="col-md-6 col-12 mt-3 text-center  pay-type">
                                                        <label for="typePay4" class="outline-radio">
                                                            <input type="radio" name="typePay" value="4" id="typePay4"
                                                       oninput="setCustomValidity('')" oninvalid="this.setCustomValidity('لطفا روش پرداخت را انتخاب کنید')" required="required">
                                                            <span class="outline-radio-check"></span>
                                                        </label>
                                                        <label for="typePay4" class="shipping-totals-title-row">
                                                            <div class="shipping-totals-title">
                                                                <img src="/images/Irankish-logo.png"  width="100"/>

                                                            </div>
                                                        </label>

                                                    </div>
                                                }
                                            }
                                        }
                                    }



                                </div>



                                <button class="btn-Order btn btn-primary mt-4 mb-3 btn-submit-final" type="submit">ثبت نهایی و پرداخت</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
</div>

@section Scripts
    {
    <script>
        function loading() {
            Swal.fire({
                title: "منتظر بمانید",
                imageUrl: "../gif/alert_loading.gif",
                text: "در حال ارسال اطلاعات...",
                showConfirmButton: false,
                width: 400,
            });
        }
        function getShipmentList() {
            $.ajax({
                url: "/getShipmentByAddress/" + $('input[name="addressId"]:checked').val(), success: function(result) {
                    $(".shipping-totals-item").empty();
                    var firstIsSelected = false;
                    var data = JSON.parse(result);
                    content = "";
                    if (data.length > 0) {
                        for (let i = 0; i < data.length; i++) {
                            var shipmentId = "shipmentId_" + data[i].ShipmentId;
                            content += '<div class="shipping-totals-outline  d-flex align-items-center text-right"><label ' +
                                'for="' + shipmentId + '" class="outline-radio"><input ' + (firstIsSelected == false ? "checked" : "") + ' type="radio" name="shippingId" class="cart-shipment"' +
                                ' value="' + data[i].ShipmentId + '" id="' + shipmentId + '" ' +
                                'required="required"><span class="outline-radio-check"></span></label><label for="' + shipmentId + '"' +
                                'class="shipping-totals-title-row"><div class="shipping-totals-title">' + data[i].Title
                                + (data[i].Price > 0 ? ':' + data[i].Price + " تومان" : "")
                                + (data[i].PricePerAddProduct > 0 ? "(هزینه برای هر کالای اضافه :" + data[i].PricePerAddProduct + "تومان)" : "") +
                                '</div></label></div>';
                            firstIsSelected = true;
                        }
                    }
                    else
                        content = '<span class="shipping-destination text-danger">متاسفانه سرویس حمل و نقل برای آدرس شما در نظر گرفته نشده است! لطفا آدرس جدید انتخاب کنید</span>';

                    $(".shipping-totals-item").html(content);

                    $('input[name="shippingId"]').change(function() {
                        GetShippingDetail(this.value);
                    });
                    $('input[name="shippingId"]').first().prop('checked', true);


                }
            });
        }
        function getAddressList() {
            $.ajax({
                url: "/Profile/AjaxAddresses", success: function(result) {
                    $(".checkout-payment-method-item").empty();
                    text = "";
                    var firstIsSelected = false;
                    var data = JSON.parse(result);
                    if (data && data.AddressList.length != 0) {
                        for (let i = 0; i < data.AddressList.length; i++) {
                            var addressId = "address_" + data.AddressList[i].UserAddressId;

                            text += '<li class="checkout-payment-method-item d-flex align-items-center text-right">' +
                                '<label for="' + addressId + '" class="outline-radio"><input type="radio" name="addressId" class="cart_address"' +
                                ' value="' + data.AddressList[i].UserAddressId + '" id="' + addressId + '" ' + "checked" + '/>' +
                                '<span class="outline-radio-check"></span></label><label for="' + addressId + '" class="shipping-totals-title-row">' +
                                '<div class="shipping-totals-title">استان ' + data.AddressList[i].ProvinceName + ', شهر ' + data.AddressList[i].CityName + ' , آدرس ' + data.AddressList[i].PostalAddress + ' ' +
                                ', کد پستی ' + data.AddressList[i].PostalCode + ' , تحویل گیرنده ' + data.AddressList[i].FullName + ' , تلفن ' + data.AddressList[i].Phone + '</div></label>' +
                                '</li>';
                            firstIsSelected = true;
                        }
                    }
                    else {
                        text = '<li class="checkout-payment-method-item d-block cart-alert-no-address-exist"><h6>شما تا کنون آدرسی برای دریافت ثبت نکرده اید</h6></li>';
                    }

                    var isColleague = $("#isColleague").val();
                    if (isColleague == "0") {
                        text += '<li class="checkout-payment-method-item d-flex align-items-center text-right"><a style="color: #d90268;" data-toggle="modal" data-target=".bd-example-modal-lg"' +
                            'class="btn btn-add-address-card"><i style="margin-left: 10px;" class="fa fa-plus"></i>افزودن آدرس جدید</a></li>';
                    } else {
                        text += '<li class="checkout-payment-method-item d-flex align-items-center text-right"><a style="color: #d90268;" href="/user/profile/createaddress"' +
                            'class="btn btn-add-address-card"><i style="margin-left: 10px;" class="fa fa-plus"></i>افزودن آدرس جدید</a></li>';

                    }

                    $(".checkout-payment-methods").html(text);
                    getShipmentList();
                    $('input[name="addressId"]').change(function() {
                        loading();
                        $.ajax({
                            url: '/cart/SubmitAddress/' + $(this).val(),
                            type: 'POST',
                            data: { 'addressId': $(this).val() },
                            dataType: 'json',
                            'success': function(response) {
                                getShipmentList();
                                Swal.close();
                            },
                        });
                    });
                }
            });

        }
        function GetShippingDetail(value) {
            loading();
            $.ajax({
                url: '/cart/submitShipping/' + value,
                type: 'POST',
                data: { 'shippingId': value },
                dataType: 'json', 'success': function(response) {
                    document.getElementById('shipping-amount').innerText = JSON.parse(response).price + ' تومان';
                    document.getElementById('total-amount').innerText =
                        (parseInt(document.getElementById('main-total-amount').innerText) + parseInt(JSON.parse(response).price)) + ' تومان';
                    document.getElementById('total-amount-final').innerText =
                        (parseInt(document.getElementById('main-total-amount').innerText) + parseInt(JSON.parse(response).price)) + ' تومان';
                    Swal.close();
                },
            });
        }
        $(document).ready(function() {
            getAddressList();
            GetShippingDetail(2);
            $('.cart_address').change(function() {
                $('#mainform').submit();
            })

            $('.cart-shipment').change(function() {
                $('#mainform-shipment').submit();
            })


            $(".province").change(function() {
                var id = $(this).children("option:selected").val();
                var cityselect = $("#cityid");
                $.ajax({
                    type: "POST",
                    url: "/Profile/GetCity",
                    data: { id: id },
                    success: function(data) {
                        debugger;
                        cityselect.children('.js-item').remove();
                        data.forEach(function(item) {
                            cityselect.append($("<option value='" + item.CityId + "' class='js-item'>" + item.CityName + "</option>"));
                        });
                    }
                });

            });
            $("#CreditPrice").change(function() {
                var price = parseInt($(this).val());
                document.getElementById('total-amount-credit').innerText = price.toLocaleString() + ' تومان';
                var finalPrice = (parseInt(document.getElementById('main-total-amount').innerText)) - price;
                if (finalPrice < 0) {
                    finalPrice = 0;
                }
                if (finalPrice == 0) {
                    $(".pay-type").slideUp();
                } else {
                    $(".pay-type").slideDown();
                }
                document.getElementById('total-amount-final').innerText = finalPrice.toLocaleString() + ' تومان';

            });

            $(".btn-registrar").click(function(e) {

                $.fn.serializeObject = function() {
                    var o = {};
                    var a = this.serializeArray();
                    $.each(a, function() {
                        if (o[this.name] !== undefined) {
                            if (!o[this.name].push) {
                                o[this.name] = [o[this.name]];
                            }
                            o[this.name].push(this.value || '');
                        } else {
                            o[this.name] = this.value || '';
                        }
                    });
                    return o;
                };

                e.preventDefault();
                loading();
                $.ajax({
                    url: "/Profile/AjaxCreateAddress",
                    type: "POST",
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    data: (JSON.stringify($("#addaddressform").serializeObject())),
                    success: function(response) {
                        getAddressList();
                        Swal.close();
                        $('.modal').modal('hide');
                    },
                });
            })
        })

    </script>
}


